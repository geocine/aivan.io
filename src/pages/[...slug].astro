---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Container from '../components/Container.astro';
import moment from 'moment';
import authors from '../data/authors.json';
import { IoMdArrowBack, IoMdArrowForward } from 'react-icons/io';
import ColorBox from '../components/mdx-components/ColorBox';
import Message from '../components/mdx-components/Message';
import Grid from '../components/mdx-components/Grid';
import Subtitle from '../components/mdx-components/Subtitle';
import SmallTitle from '../components/mdx-components/SmallTitle';
import Title from '../components/mdx-components/Title';
import Paragraph from '../components/mdx-components/Paragraph';
import Separator from '../components/mdx-components/Separator';
import List from '../components/mdx-components/List';
import NumberedList from '../components/mdx-components/NumberedList';
import Anchor from '../components/mdx-components/Anchor';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const posts = allPosts
    .filter(post => import.meta.env.PROD ? post.data.published : true)
    .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

  return posts.map((post, index) => ({
    params: { slug: post.slug },
    props: {
      post,
      previous: index < posts.length - 1 ? posts[index + 1] : null,
      next: index > 0 ? posts[index - 1] : null,
    },
  }));
}

const { post, previous, next } = Astro.props;
const { Content } = await post.render();

const authorData = authors.find(auth => auth.id === post.data.author);
const formattedDate = moment(post.data.date).format('MMMM DD, YYYY');

function getCover() {
  const slug = post.slug.replace(/^\/|\/$/g, '');
  const cover = (post.data.cover || '').replace(/^\/|\/$/g, '');
  return `${slug}/${cover}`;
}

const imageHost = 'https://cdn.aivan.io';
const coverUrl = `${imageHost}/${getCover()}`;
const pageTitle = post.data.title;
const pageDescription = post.data.meta_description || '';
---

<Layout title={pageTitle} description={pageDescription} image={getCover()}>
  <style is:global>
    .post-header {
      overflow: hidden;
      max-width: calc(100% + 40px);
      margin-top: calc(-65px - 1.45rem);
      margin-bottom: 40px;
      padding-top: 40px;
      padding-left: 20px;
      padding-right: 20px;
      background: #006cb7;
    }

    @media (min-width: 768px) {
      .post-header {
        margin-top: calc(-80px - 1.45rem);
      }
    }

    .post-header h1 {
      max-width: 850px;
      margin: 0 auto 20px auto;
    }

    .cover-image-wrapper {
      position: relative;
      max-width: 600px;
      margin: 0 auto;
      overflow: visible !important;
    }

    .cover-image-wrapper::before {
      content: '';
      position: absolute;
      left: -100vw;
      right: -100vw;
      bottom: 0;
      height: 50%;
      background-color: #fff;
    }

    .cover-image {
      position: relative;
      border-radius: 4px;
      box-shadow: 0 0 5px 2px rgba(0, 0, 0, 0.1);
      border: 0;
      border-color: transparent;
    }

    .post-content {
      font-size: 18px;
      line-height: 1.6;
      color: #1a202c;
    }

    .post-content p {
      margin: 15px 0;
      line-height: 1.6;
    }

    /* First paragraph special styling */
    .post-content .first-paragraph {
      border-left: 4px solid #ff8e01;
      padding-left: 20px;
      margin-bottom: 25px;
      font-size: 20px;
      line-height: 1.6;
      margin-top: 15px;
    }

    .post-content h2 {
      font-size: 32px;
      margin-top: 50px;
      margin-bottom: 25px;
      color: #1a202c;
    }

    .post-content h3 {
      font-size: 24px;
      margin-top: 40px;
      margin-bottom: 20px;
      color: #1a202c;
    }

    .post-content h4 {
      font-size: 20px;
      margin-top: 30px;
      margin-bottom: 15px;
      color: #1a202c;
    }

    .post-content a {
      color: #0161ab;
      text-decoration: none;
      transition: color 0.33s ease-out;
    }

    .post-content a:hover {
      color: #ff8e01;
    }

    .post-content code {
      background-color: #d1ebfd;
      color: #1a202c;
      padding: 5px 7px 0;
      white-space: pre-wrap;
      border-bottom: 2px solid #006cb7;
      border-radius: 4px;
      font-size: 15px;
      line-height: inherit;
    }

    .post-content pre {
      background-color: #2d3033 !important;
      border-radius: 4px;
      font-size: 16px;
      padding: 10px;
      overflow-x: auto;
      margin: 20px 0;
    }

    .post-content pre code {
      background: transparent;
      color: rgb(217, 239, 255);
      border: none;
      padding: 0;
      font-size: 16px;
    }

    .post-content pre::-webkit-scrollbar {
      width: 100%;
      height: 5px;
      border-radius: 0 0 5px 5px;
    }

    .post-content pre::-webkit-scrollbar-track {
      background: #061526;
      border-radius: 0 0 4px 4px;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .post-content pre::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 5px;
    }

    /* Expressive Code overrides */
    .post-content .expressive-code {
      margin: 20px 0;
      font-size: 16px;
    }

    .post-content .expressive-code pre {
      background-color: #2d3033 !important;
      padding: 10px;
    }

    .post-content .expressive-code .line {
      padding-left: 0;
    }

    /* Line numbers gutter */
    .post-content .expressive-code .gutter {
      display: inline-block;
      min-width: 2em;
      text-align: right;
      padding-right: 0.75em;
      padding-left: 0.5em;
      user-select: none;
      opacity: 0.5;
    }

    .post-content .expressive-code .ln {
      color: #999;
    }

    /* Line highlighting */
    .post-content .expressive-code .ec-line.mark {
      background-color: rgba(85, 66, 42, 0.61);
      margin: 0 -10px;
      padding: 0 5px;
      border-left: 5px solid #ff8e01;
    }

    .post-content ul,
    .post-content ol {
      margin: 20px 0;
      padding-left: 30px;
    }

    .post-content li {
      margin: 10px 0;
    }

    .post-content li code {
      color: #1a202c;
    }

    .post-content img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      box-shadow: 0 0 5px 2px rgba(0, 0, 0, 0.1);
    }

    .post-content blockquote {
      border-left: 4px solid #006cb7;
      padding-left: 20px;
      margin: 20px 0;
      color: #4a5568;
    }

    /* Custom unordered list styling */
    .post-content .mdx-list {
      margin-left: 20px;
      list-style-type: none;
      position: relative;
    }

    .post-content .mdx-list li {
      position: relative;
      border-bottom: 2px solid #aedeff;
      margin-bottom: 0.8em;
      padding-bottom: 0.7em;
      padding-left: 20px;
    }

    .post-content .mdx-list li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0.6em;
      width: 0;
      height: 0;
      border-left: 6px solid #006cb7;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
    }

    /* Custom numbered list styling */
    .post-content .mdx-numbered-list {
      padding: 0 0 0 30px;
      list-style: none;
      counter-reset: numList;
      position: relative;
    }

    .post-content .mdx-numbered-list li {
      position: relative;
      margin-bottom: 1em;
      padding-left: 10px;
    }

    .post-content .mdx-numbered-list li::before {
      counter-increment: numList;
      content: counter(numList);
      position: absolute;
      left: -30px;
      top: 0;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #0161ab;
      color: #fff;
      font-size: 16px;
      display: inline-block;
      text-align: center;
      line-height: 25px;
    }

    .post-content .mdx-numbered-list li img {
      margin: 15px 0;
      border-radius: 5px;
    }

    .post-content li code {
      color: #1a202c;
    }

    @media (min-width: 768px) {
      .post-content pre {
        border-radius: 4px;
      }
    }
  </style>
  <article>
    <!-- Post Header with Blue Background -->
    <div class="post-header">
      <div class="text-center">
        <h1 class="mt-2 font-semibold text-[28px] md:text-4xl leading-[1.375] text-white">
          {post.data.title}
        </h1>
        <div class="inline-flex items-center mt-2 mb-4 text-sm leading-[30px] text-white">
          <img
            src={authorData?.avatar}
            alt={authorData?.name}
            class="w-8 h-8 rounded-full mr-2"
          />
          <a href="#" class="hover:text-minor text-white">{authorData?.name}</a>
          <span class="ml-2">{formattedDate}</span>
        </div>
      </div>

      <!-- Cover Image with white background on bottom half -->
      <div class="cover-image-wrapper">
        <img
          src={coverUrl}
          alt={post.data.title}
          class="cover-image w-full"
          loading="eager"
        />
      </div>
    </div>

    <!-- Post Body -->
    <Container>
      <div class="post-content">
        <Content components={{
          h2: Subtitle,
          h3: SmallTitle,
          h4: Title,
          p: Paragraph,
          hr: Separator,
          ul: List,
          ol: NumberedList,
          a: Anchor,
          ColorBox,
          Message,
          Grid
        }} />
      </div>

      <!-- Post Footer Navigation -->
      <div class="my-6">
        <ul class="flex flex-wrap justify-between list-none p-0">
          <li>
            {previous && (
              <a href={`/${previous.slug}/`} rel="prev" class="text-major hover:text-minor inline-flex items-center">
                <IoMdArrowBack className="inline-block mr-1" /> Previous
              </a>
            )}
          </li>
          <li>
            {next && (
              <a href={`/${next.slug}/`} rel="next" class="text-major hover:text-minor inline-flex items-center">
                Next <IoMdArrowForward className="inline-block ml-1" />
              </a>
            )}
          </li>
        </ul>
      </div>
    </Container>
  </article>
  <script is:inline>
    // Add first-paragraph class to the actual first paragraph
    const postContent = document.querySelector('.post-content');
    if (postContent) {
      // Find all paragraph elements (both p and .mdx-paragraph)
      const paragraphs = postContent.querySelectorAll('p');
      if (paragraphs.length > 0) {
        paragraphs[0].classList.add('first-paragraph');
      }
    }
  </script>
</Layout>
